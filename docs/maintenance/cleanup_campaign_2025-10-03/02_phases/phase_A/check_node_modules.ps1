# Script de v√©rification node_modules tracking Git
# Phase A.2.3 - Campagne Nettoyage D√©p√¥t 2025-10-03
# CRITIQUE : Ne PAS supprimer sans validation si track√©s

Write-Host "=== V√©rification node_modules ===" -ForegroundColor Cyan
Write-Host ""

# V√©rifier si node_modules sont track√©s par Git
Write-Host "[1/4] V√©rification tracking Git pour node_modules..." -ForegroundColor Yellow
$trackedFiles = git ls-files "services/**/node_modules/" 2>&1

if ($trackedFiles -and ($trackedFiles -notmatch "fatal")) {
    Write-Host "‚ùå ALERTE CRITIQUE : node_modules sont track√©s dans Git!" -ForegroundColor Red
    Write-Host ""
    Write-Host "Fichiers track√©s :" -ForegroundColor Yellow
    $trackedFiles | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
    Write-Host ""
    Write-Host "‚ö†Ô∏è NE PAS SUPPRIMER - Validation utilisateur requise" -ForegroundColor Red
    Write-Host "Actions recommand√©es :" -ForegroundColor Yellow
    Write-Host "  1. Retirer du tracking : git rm -r --cached services/**/node_modules/" -ForegroundColor Gray
    Write-Host "  2. V√©rifier .gitignore contient 'node_modules/'" -ForegroundColor Gray
    Write-Host "  3. Commit changements" -ForegroundColor Gray
    Write-Host "  4. Supprimer localement : Remove-Item -Recurse -Force services/**/node_modules/" -ForegroundColor Gray
    $tracked = $true
} else {
    Write-Host "‚úÖ node_modules ne sont PAS track√©s" -ForegroundColor Green
    $tracked = $false
}

Write-Host ""

# V√©rifier .gitignore
Write-Host "[2/4] V√©rification .gitignore..." -ForegroundColor Yellow
$gitignorePath = ".gitignore"
if (Test-Path $gitignorePath) {
    $gitignoreContent = Get-Content $gitignorePath -Raw
    if ($gitignoreContent -match "node_modules/") {
        Write-Host "‚úÖ node_modules/ est dans .gitignore" -ForegroundColor Green
        $inGitignore = $true
    } else {
        Write-Host "‚ö†Ô∏è node_modules/ n'est PAS dans .gitignore" -ForegroundColor Yellow
        Write-Host "Recommandation : Ajouter 'node_modules/' au .gitignore" -ForegroundColor Gray
        $inGitignore = $false
    }
} else {
    Write-Host "‚ùå Fichier .gitignore introuvable" -ForegroundColor Red
    $inGitignore = $false
}

Write-Host ""

# V√©rifier existence et taille node_modules
Write-Host "[3/4] Analyse des dossiers node_modules..." -ForegroundColor Yellow
$nodeModulesDirs = Get-ChildItem -Path "services" -Recurse -Directory -Filter "node_modules" -ErrorAction SilentlyContinue

if ($nodeModulesDirs) {
    Write-Host "Dossiers node_modules trouv√©s : $($nodeModulesDirs.Count)" -ForegroundColor Cyan
    $totalSize = 0
    
    foreach ($dir in $nodeModulesDirs) {
        $size = (Get-ChildItem -Path $dir.FullName -Recurse -File -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
        $sizeMB = [math]::Round($size / 1MB, 2)
        $totalSize += $size
        Write-Host "  - $($dir.FullName): $sizeMB MB" -ForegroundColor Gray
    }
    
    $totalSizeMB = [math]::Round($totalSize / 1MB, 2)
    Write-Host ""
    Write-Host "Taille totale : $totalSizeMB MB" -ForegroundColor Cyan
} else {
    Write-Host "Aucun dossier node_modules trouv√©" -ForegroundColor Green
    $totalSizeMB = 0
}

Write-Host ""

# R√©sum√© et recommandations
Write-Host "[4/4] R√©sum√© et Recommandations" -ForegroundColor Yellow
Write-Host "================================" -ForegroundColor Yellow
Write-Host ""

if ($tracked) {
    Write-Host "üî¥ STATUT : CRITIQUE - node_modules TRACK√âS" -ForegroundColor Red
    Write-Host ""
    Write-Host "ACTIONS REQUISES :" -ForegroundColor Yellow
    Write-Host "1. ‚ö†Ô∏è NE PAS supprimer directement" -ForegroundColor Red
    Write-Host "2. Retirer du tracking Git d'abord" -ForegroundColor Gray
    Write-Host "3. V√©rifier/ajouter √† .gitignore" -ForegroundColor Gray
    Write-Host "4. Commit les changements" -ForegroundColor Gray
    Write-Host "5. PUIS supprimer localement" -ForegroundColor Gray
} elseif (-not $inGitignore) {
    Write-Host "üü° STATUT : ATTENTION - Non track√© mais absent de .gitignore" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "ACTIONS RECOMMAND√âES :" -ForegroundColor Yellow
    Write-Host "1. Ajouter 'node_modules/' au .gitignore" -ForegroundColor Gray
    Write-Host "2. Commit le .gitignore mis √† jour" -ForegroundColor Gray
    Write-Host "3. node_modules peut √™tre supprim√© en s√©curit√©" -ForegroundColor Gray
} else {
    Write-Host "‚úÖ STATUT : S√âCURIS√â - Non track√© et dans .gitignore" -ForegroundColor Green
    Write-Host ""
    Write-Host "ACTIONS POSSIBLES :" -ForegroundColor Yellow
    Write-Host "1. Suppression s√©curis√©e possible si n√©cessaire" -ForegroundColor Gray
    Write-Host "2. R√©cup√©ration espace : $totalSizeMB MB" -ForegroundColor Gray
    Write-Host "3. Peut √™tre r√©g√©n√©r√© avec 'npm install'" -ForegroundColor Gray
}

Write-Host ""
Write-Host "=== V√©rification termin√©e ===" -ForegroundColor Cyan

# Retourner le code de sortie appropri√©
if ($tracked) {
    exit 1  # Erreur - node_modules track√©s
} else {
    exit 0  # Succ√®s
}