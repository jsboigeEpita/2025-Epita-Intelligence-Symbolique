#!/usr/bin/env python3
"""
Script de nettoyage progressif des erreurs flake8.
Mission D-CI-06 Phase 5c - Nettoyage imports inutilis√©s (F401, F841).
"""

import subprocess
import sys
from pathlib import Path
import time

# R√©pertoires √† nettoyer par ordre de priorit√© (moins risqu√© en premier)
DIRECTORIES_TO_CLEAN = [
    "demos/",
    "examples/",
    "scripts/",
    "project_core/",
    "argumentation_analysis/",
]


def run_command(cmd, cwd=None):
    """Ex√©cute une commande et retourne le r√©sultat."""
    result = subprocess.run(
        cmd,
        shell=True,
        capture_output=True,
        text=True,
        encoding="utf-8",
        errors="replace",
        cwd=cwd,
    )
    return result


def count_flake8_errors(directory="."):
    """Compte le nombre d'erreurs flake8 dans un r√©pertoire."""
    result = run_command(f"python -m flake8 {directory}")
    lines = [l for l in result.stdout.split("\n") if l.strip()]
    return len(lines)


def clean_directory_with_autoflake(directory):
    """Nettoie un r√©pertoire avec autoflake."""
    print(f"\n{'='*60}")
    print(f"üìÅ Nettoyage de : {directory}")
    print(f"{'='*60}")

    # Compter les erreurs avant
    print(f"\nüîç Analyse flake8 AVANT nettoyage...")
    errors_before = count_flake8_errors(directory)
    print(f"   Erreurs d√©tect√©es : {errors_before}")

    # Dry-run autoflake pour voir ce qui serait modifi√©
    print(f"\nüß™ Simulation autoflake (dry-run)...")
    dry_run_cmd = f"python -m autoflake --remove-all-unused-imports --remove-unused-variables --recursive --check {directory}"
    dry_run_result = run_command(dry_run_cmd)

    files_to_modify = [l for l in dry_run_result.stdout.split("\n") if "Unused" in l]
    print(f"   Fichiers √† modifier : {len(files_to_modify)}")

    if len(files_to_modify) == 0:
        print(f"   ‚úÖ Aucune modification n√©cessaire dans {directory}")
        return {
            "directory": directory,
            "errors_before": errors_before,
            "errors_after": errors_before,
            "files_modified": 0,
            "status": "skipped",
        }

    # Application r√©elle
    print(f"\n‚ú® Application du nettoyage autoflake...")
    clean_cmd = f"python -m autoflake --remove-all-unused-imports --remove-unused-variables --recursive --in-place {directory}"
    clean_result = run_command(clean_cmd)

    print(f"   ‚úÖ Nettoyage termin√©")

    # Compter les erreurs apr√®s
    print(f"\nüîç Analyse flake8 APR√àS nettoyage...")
    errors_after = count_flake8_errors(directory)
    print(f"   Erreurs d√©tect√©es : {errors_after}")

    reduction = errors_before - errors_after
    if reduction > 0:
        percentage = (reduction / errors_before) * 100 if errors_before > 0 else 0
        print(f"   üìâ R√©duction : -{reduction} erreurs (-{percentage:.1f}%)")
    else:
        print(
            f"   ‚ö†Ô∏è  Pas de r√©duction d'erreurs (peut-√™tre des erreurs non-F401/F841)"
        )

    return {
        "directory": directory,
        "errors_before": errors_before,
        "errors_after": errors_after,
        "files_modified": len(files_to_modify),
        "reduction": reduction,
        "status": "completed",
    }


def main():
    """Fonction principale."""
    print(
        """
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  MISSION D-CI-06 PHASE 5c                                 ‚ïë
‚ïë  Nettoyage Progressif des Erreurs Flake8                  ‚ïë
‚ïë  Cible : F401 (imports inutilis√©s), F841 (vars inutilis√©es) ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""
    )

    # Baseline globale
    print("\nüìä BASELINE INITIALE (tout le projet)")
    total_errors_initial = count_flake8_errors(".")
    print(f"   Total erreurs flake8 : {total_errors_initial}")

    results = []

    # Nettoyer chaque r√©pertoire
    for directory in DIRECTORIES_TO_CLEAN:
        if not Path(directory).exists():
            print(f"\n‚ö†Ô∏è  R√©pertoire {directory} n'existe pas, passage au suivant...")
            continue

        result = clean_directory_with_autoflake(directory)
        results.append(result)

        # Pause pour laisser le temps de v√©rifier
        time.sleep(1)

    # Rapport final
    print(f"\n{'='*60}")
    print("üìä RAPPORT FINAL DE NETTOYAGE")
    print(f"{'='*60}\n")

    total_reduction = 0
    total_files_modified = 0

    for result in results:
        if result["status"] == "completed":
            print(
                f"‚úÖ {result['directory']:30s} | "
                f"Avant: {result['errors_before']:6d} | "
                f"Apr√®s: {result['errors_after']:6d} | "
                f"R√©duction: -{result['reduction']:5d}"
            )
            total_reduction += result["reduction"]
            total_files_modified += result["files_modified"]
        else:
            print(f"‚è≠Ô∏è  {result['directory']:30s} | Pas de modifications n√©cessaires")

    print(f"\n{'='*60}")
    print(f"üìà STATISTIQUES GLOBALES")
    print(f"{'='*60}")
    print(f"   Erreurs initiales     : {total_errors_initial:,}")

    total_errors_final = count_flake8_errors(".")
    print(f"   Erreurs finales       : {total_errors_final:,}")
    print(f"   R√©duction totale      : -{total_errors_initial - total_errors_final:,}")

    if total_errors_initial > 0:
        percentage = (
            (total_errors_initial - total_errors_final) / total_errors_initial
        ) * 100
        print(f"   Pourcentage r√©duit    : {percentage:.2f}%")

    print(f"   Fichiers modifi√©s     : {total_files_modified}")

    print(f"\nüíæ Prochaines √©tapes recommand√©es :")
    print(f"   1. V√©rifier les modifications : git diff")
    print(f"   2. Ex√©cuter black : python -m black --check .")
    print(
        f"   3. Commit interm√©diaire : git add . && git commit -m 'refactor: remove unused imports (F401, F841) - D-CI-06 Phase 5c'"
    )

    return 0


if __name__ == "__main__":
    sys.exit(main())
